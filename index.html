<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FL Global & Client Weights Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 2rem; max-width: 1100px; }
    h1 { margin-bottom: .5rem; }
    h2 { margin: 1.5rem 0 .5rem; }
    p.hint { color: #666; margin-top: 0; }
    fieldset { border: 1px solid #8883; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    legend { font-weight: 600; padding: 0 .5rem; }
    label { display: block; font-size: .95rem; margin: .5rem 0 .25rem; }
    input[type="text"], input[type="password"] { width: 100%; padding: .6rem .7rem; border-radius: 10px; border: 1px solid #8883; }
    input[type="file"] { margin-top: .25rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    button { padding: .7rem 1rem; border-radius: 10px; border: 1px solid #4443; cursor: pointer; font-weight: 600; }
    button.primary { background: #2ea043; color: white; border: none; }
    button.warn { background: #d63636; color: white; border: none; }
    .muted { opacity: .85; color: #666 }
    table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
    th, td { padding: .6rem .5rem; border-bottom: 1px solid #8883; text-align: left; }
    th { background: #00000008; }
    code { background: #00000010; padding: .05rem .3rem; border-radius: 6px; }
    .badge { display:inline-block; padding:.2rem .5rem; border-radius: 999px; background:#00000012; font-size:.8rem }
    .flex { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    progress { width: 100%; height: 10px; }
  </style>
</head>
<body>
  <h1>Federated Learning – Global & Client Weights</h1>
  <p class="hint">Keep this page local. Use a fine-grained GitHub token with <b>Contents: Read and write</b> access to your private repo.</p>

  <!-- Shared GitHub config -->
  <fieldset>
    <legend>GitHub Repository & Auth</legend>
    <div class="row">
      <div>
        <label for="owner">Owner/Org</label>
        <input id="owner" type="text" placeholder="Triss11" required />
      </div>
      <div>
        <label for="repo">Repository</label>
        <input id="repo" type="text" placeholder="FL" required />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="branch">Default Branch</label>
        <input id="branch" type="text" value="main" required />
      </div>
      <div>
        <label for="token">GitHub Personal Access Token (fine-grained)</label>
        <input id="token" type="password" placeholder="ghp_..." required />
      </div>
    </div>
    <div class="flex">
      <button type="button" id="checkAuth">Check Access</button>
      <span id="authStatus" class="muted"></span>
    </div>
  </fieldset>

  <!-- 1) Global model download -->
  <h2>1) Download Global Model</h2>
  <fieldset>
    <legend>Global Model (.keras)</legend>
    <div class="row">
      <div>
        <label for="globalPath">Path in repo</label>
        <input id="globalPath" type="text" value="M.Tech_Dissertation/my_model.keras" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="primary" id="downloadGlobal">Download Global Model</button>
      </div>
    </div>
    <div id="globalStatus" class="muted"></div>
  </fieldset>

  <!-- 2) Client weights upload -->
  <h2>2) Upload Client Weights</h2>
  <fieldset>
    <legend>Upload weights</legend>
    <div class="row3">
      <div>
        <label for="clientId">Client ID</label>
        <input id="clientId" type="text" placeholder="client1" />
      </div>
      <div>
        <label for="roundNum">Round</label>
        <input id="roundNum" type="text" placeholder="1" />
      </div>
      <div>
        <label for="weightsPath">Path in repo</label>
        <input id="weightsPath" type="text" value="model/" />
      </div>
    </div>
    <label for="file">Select weights file</label>
    <input id="file" type="file" accept=".weights.h5,.h5,.npz,.ckpt,.bin" required />
    <div id="fileInfo" class="muted"></div>

    <label for="commitMsg">Commit message</label>
    <input id="commitMsg" type="text" value="Upload federated client weights" />

    <div class="flex" style="margin-top:.5rem;">
      <button class="primary" id="uploadBtn">Upload Weights</button>
      <button type="button" id="listRepoWeights">Refresh Table</button>
    </div>
    <div style="margin-top:.5rem;"><progress id="prog" value="0" max="100" hidden></progress></div>
    <div id="uploadStatus" class="muted"></div>
  </fieldset>

  <!-- 3) Table -->
  <h2>3) Client Weights Registry & Downloads</h2>
  <fieldset>
    <legend>Registry</legend>
    <table id="weightsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Client</th>
          <th>Round</th>
          <th>File</th>
          <th>Size</th>
          <th>Path</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="tableStatus" class="muted"></div>
  </fieldset>

<script>
const el = id => document.getElementById(id);

function saveRegistry(reg) { localStorage.setItem('flRegistry', JSON.stringify(reg)); }
function loadRegistry() { return JSON.parse(localStorage.getItem('flRegistry') || '[]'); }
function renderTable(reg) {
  const tbody = el('weightsTable').querySelector('tbody');
  tbody.innerHTML = '';
  reg.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.client}</td>
      <td>${r.round}</td>
      <td>${r.fileName}</td>
      <td>${r.sizeMB ? r.sizeMB.toFixed(2)+' MB':''}</td>
      <td><code>${r.repoPath}</code></td>
      <td>
        <button onclick="downloadFromRepo('${r.repoPath}','${r.fileName}')">Download</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function gh(url, token, options={}) {
  const res = await fetch(url, {headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'},...options});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function getFileMeta({token,owner,repo,path,ref}) {
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${ref}`;
  const r=await fetch(url,{headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'}});
  if(r.status===404) return null;
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function putFile({token,owner,repo,path,branch,contentB64,message,sha}) {
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const res=await fetch(url,{method:'PUT',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json',Accept:'application/vnd.github+json'},body:JSON.stringify({message,content:contentB64,branch,sha})});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
function base64FromArrayBuffer(buf) {
  const chunk=0x8000,bytes=new Uint8Array(buf); let bin='';
  for(let i=0;i<bytes.length;i+=chunk){bin+=String.fromCharCode.apply(null,bytes.subarray(i,i+chunk));}
  return btoa(bin);
}

async function downloadFromRepo(repoPath,suggestedName){
  const token=el('token').value.trim(),owner=el('owner').value.trim(),repo=el('repo').value.trim(),branch=el('branch').value.trim();
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${repoPath}?ref=${branch}`;
  const res=await fetch(url,{headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github.raw'}});
  if(!res.ok) throw new Error(await res.text());
  const blob=await res.blob(); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=suggestedName||repoPath.split('/').pop();
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),1500);
}

el('file').addEventListener('change',()=>{const f=el('file').files?.[0]; if(f){el('fileInfo').textContent=`${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;}});

el('uploadBtn').addEventListener('click',async()=>{
  const token=el('token').value.trim(),owner=el('owner').value.trim(),repo=el('repo').value.trim(),branch=el('branch').value.trim();
  const client=el('clientId').value.trim()||'client',round=el('roundNum').value.trim()||'1',basePath=el('weightsPath').value.trim()||'model/';
  const file=el('file').files?.[0]; if(!file) return;
  const fileName=`${client}_round${round}.${file.name.split('.').pop()}`,repoPath=(basePath.endsWith('/')?basePath:basePath+'/')+fileName;
  const buf=await file.arrayBuffer(),contentB64=base64FromArrayBuffer(buf);
  await putFile({token,owner,repo,path:repoPath,branch,contentB64,message:el('commitMsg').value,sha:null});
  const reg=loadRegistry(); reg.push({client,round,fileName,sizeMB:file.size/1024/1024,repoPath}); saveRegistry(reg); renderTable(reg);
  el('uploadStatus').textContent='✅ Uploaded';
});

el('downloadGlobal').addEventListener('click',async()=>{
  const path=el('globalPath').value.trim(); try{await downloadFromRepo(path,path.split('/').pop()); el('globalStatus').textContent='✅ Download started';}
  catch(e){el('globalStatus').textContent='❌ '+e.message;}
});

el('checkAuth').addEventListener('click',async()=>{
  try{await gh(`https://api.github.com/repos/${el('owner').value}/${el('repo').value}`,el('token').value); el('authStatus').textContent='✅ OK';}
  catch(e){el('authStatus').textContent='❌ '+e.message;}
});

el('listRepoWeights').addEventListener('click',async()=>{
  const token=el('token').value.trim(),owner=el('owner').value.trim(),repo=el('repo').value.trim(),branch=el('branch').value.trim(),basePath=el('weightsPath').value.trim()||'model/';
  try{const url=`https://api.github.com/repos/${owner}/${repo}/contents/${basePath}?ref=${branch}`;
    const res=await fetch(url,{headers:{Authorization:`Bearer ${token}`,Accept:'application/vnd.github+json'}}); if(!res.ok) throw new Error(await res.text());
    const data=await res.json(); const reg=loadRegistry();
    data.forEach(it=>{if(it.type==='file'&&/\.(weights\.h5|npz|h5)$/i.test(it.name)){if(!reg.some(r=>r.repoPath===it.path)){reg.push({client:'-',round:'-',fileName:it.name,sizeMB:it.size/1024/1024,repoPath:it.path});}}});
    saveRegistry(reg); renderTable(reg); el('tableStatus').textContent='✅ Refreshed';
  }catch(e){el('tableStatus').textContent='❌ '+e.message;}
});

renderTable(loadRegistry());
</script>
</body>
</html>
